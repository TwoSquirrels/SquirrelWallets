import com.github.javaparser.JavaParser
import com.github.javaparser.ast.body.ClassOrInterfaceDeclaration
import com.github.javaparser.ast.comments.Comment
import com.github.javaparser.ast.comments.JavadocComment
import org.json.JSONObject
import org.yaml.snakeyaml.Yaml

buildscript {
    repositories{
        mavenCentral()
    }
    dependencies {
        classpath("org.yaml:snakeyaml:1.17")
        classpath("org.json:json:20210307")
        classpath("com.github.javaparser:javaparser-core:3.3.0")
    }
}

plugins {
    id 'java'
    id 'maven-publish'
    id 'groovy'
}

// Import plugin.yml with SnakeYaml
Yaml yaml = new Yaml()
JSONObject pluginInfo = new JSONObject((Map<String, Object>) yaml.load(
        new FileInputStream(new File("$projectDir/src/main/resources/plugin.yml"))
))

// Replace javadoc with JavaParser
new File("$projectDir/src/main/java").eachFileRecurse { file ->
    if (!file.isFile()) return
    println ">>> " + file.getName()
    def unit = JavaParser.parse(file)
    println unit
    unit.getChildNodesByType(ClassOrInterfaceDeclaration.class).stream()
            .map(classOrInterface ->
                    classOrInterface.getComment().orElse(new JavadocComment(""))
            )
            .forEach(System.out::println)
    // TODO: Replace the code in the source file with unit.
}

repositories {
    mavenLocal()
    maven {
        url = uri('https://hub.spigotmc.org/nexus/content/repositories/snapshots/')
    }
    maven {
        url = uri('https://oss.sonatype.org/content/groups/public/')
    }
    maven {
        url = uri('https://repo.maven.apache.org/maven2/')
    }
}

dependencies {
    compileOnly 'org.spigotmc:spigot-api:1.16.5-R0.1-SNAPSHOT'
}

group = 'io.github.twosquirrels'
version = pluginInfo.getString("version")
description = pluginInfo.getString("name")

java {
    sourceCompatibility = JavaVersion.VERSION_1_8
    targetCompatibility = JavaVersion.VERSION_1_8
}

tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
}
