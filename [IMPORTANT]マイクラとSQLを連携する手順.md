by ひろ(hiro-dev)#7384 at 2021/03/21

# e.g. アイテムを買う

HoppinBro172 は 100 $ 持ってます

1. 意思確認/意思決定
    - たとえば ダイヤモンド x 1 を 50 $ で購入する  

1. トランザクションの確認
    - 所持金 => 購入価格 であることを確認する  
    - 現在そのプレイヤーについてトランザクションが行われていないか確認する  
    - プレイヤーがアイテムを所持できるか確認する  

1. トランザクションの実行
    - まずは「トランザクションを行う」という事実を残す  
      [SQL: トランザクション 固有ID 123456 / 日時 2021.03.21 22:24 / HoppinBro172  / ダイヤモンド / 状態: 未実行  
    - 次に、楽観的処理を行う  
      [SQL:トランザクション] 固有ID 123456 について更新  状態: 引き落としOK  
      [SQL: 所持金/API] HoppinBro172  について UPDATE balanceTable 'balance' = balance - 50 where uuid = ...  
      トランザクションに COMMIT を行う (ここで電源が落ちてもSQLがトランザクションの内容をディスクに書き込んでいるので、再起動時に実行してくれる)  
    - 最後に、アイテムを渡す  
      [ゲーム内] /give HoppinBro172 minecraft:diamond{customTags:{TransactionId: 123456}} 1  
      [SQL: トランザクション]  固有ID 123456 について更新   状態: 完了  
      ただちに COMMIT  
      
1. 完了
   [ゲーム内] HoppinBro172 の持つ diamond{TransactionId:123456} このNBTを削除する  
   [SQL: トランザクション] 固有ID 123456 を削除  

アイテムにNBTを無理につける必要は無いけど ゴミデータが溜まる原因になるので注意ね  
万一この場合でも、サーバーが落ちてしまった場合ユーザーは不利益をかぶることは無いよ  
ユーザーの不利益を無視するか、サーバーの不利益を無視するか でいったらサーバーなんじゃないかな...？  
